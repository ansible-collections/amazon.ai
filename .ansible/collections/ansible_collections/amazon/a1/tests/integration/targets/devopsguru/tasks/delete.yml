---
- name: Delete SQS queue
  community.aws.sns_topic:
    name: DevOpsGuruNotifications
    state: absent

- name: Delete SNS Topic
  community.aws.sns_topic:
    name: DevOpsGuruNotifications
    state: absent
  register: sns_topic

- name: Delete CloudFormation stack
  amazon.aws.cloudformation:
    stack_name: "DevOps-Guru-Stack"
    state: absent

- name: List bucket object
  amazon.aws.s3_object:
    bucket: "{{ s3_bucket_name }}"
    mode: list
  register: objects
  ignore_errors: true

- name: Remove objects from bucket
  amazon.aws.s3_object:
    bucket: "{{ s3_bucket_name }}"
    mode: delobj
    object: "{{ obj }}"
  with_items: "{{ objects.s3_keys }}"
  loop_control:
    loop_var: obj
  when: "'s3_keys' in objects"
  ignore_errors: true

- name: Delete the bucket
  amazon.aws.s3_bucket:
    name: "{{ s3_bucket_name }}"
    state: absent
  ignore_errors: true

- name: Delete the KMS key
  amazon.aws.kms_key:
    state: absent
    alias: '{{ kms_key_name }}'
