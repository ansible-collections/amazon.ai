[tox]
skipsdist = True
skip_missing_interpreters = True
envlist =
    ansible{2.17,2.18}-py{310,311,312,313}-{with_constraints,without_constraints}

[common]
collection_name = amazon.ai
collection_path = amazon/ai

format_dirs = {toxinidir}/plugins {toxinidir}/tests
lint_dirs = {toxinidir}/plugins {toxinidir}/tests

ansible_desc =
    ansible2.17: Ansible-core 2.17
    ansible2.18: Ansible-core 2.18
const_desc =
    with_constraints: (With boto3/botocore constraints)

ansible_home = {envtmpdir}/ansible_home
ansible_collections_path = {[common]ansible_home}/collections
full_collection_path = {[common]ansible_home}/collections/ansible_collections/{[common]collection_path}

[testenv:complexity-report]
labels = future-lint
description = Generate a HTML complexity report in the complexity directory
deps =
  flake8-pyproject
  flake8-html
change_dir = {toxinidir}
commands =
    -flake8 \
        --select C90 \
        --max-complexity 10 \
        --format=html \
        --htmldir={posargs:complexity} \
        {posargs:{[common]lint_dirs}}

[testenv:ansible-lint]
labels = lint
description = Run ansible-lint
deps =
  ansible-lint >= 25.1.2
  jmespath
change_dir = {toxinidir}
commands =
  ansible-lint \
        --skip-list=name[missing],yaml[line-length],args[module],run-once[task],ignore-errors,sanity[cannot-ignore],run-once[play] \
        {posargs:{[common]lint_dirs}}

[testenv:black]
labels = format
description = Apply "black" formatting
deps =
  black >=23.0, <24.0
change_dir = {toxinidir}
commands =
  black {posargs:{[common]format_dirs}}

[testenv:black-lint]
labels = lint
description = Lint against "black" formatting standards
deps =
  {[testenv:black]deps}
change_dir = {toxinidir}
commands =
  black --check --diff {posargs:{[common]format_dirs}}

[testenv:isort]
labels = format
description = Sort imports
deps =
  isort
change_dir = {toxinidir}
commands =
  isort {posargs:{[common]format_dirs}}

[testenv:isort-lint]
labels = lint
description = Lint for import sorting
deps =
  {[testenv:isort]deps}
change_dir = {toxinidir}
commands =
  isort --check-only --diff {posargs:{[common]format_dirs}}

[testenv:flynt]
labels = format
description = Apply flint (f-string) formatting
deps =
  flynt
change_dir = {toxinidir}
commands =
  flynt {posargs:{[common]format_dirs}}

[testenv:flynt-lint]
labels = lint
description = Run flint (f-string) linting
deps =
  flynt
change_dir = {toxinidir}
commands =
  flynt --dry-run --fail-on-change {posargs:{[common]format_dirs}}

[testenv:flake8-lint]
labels = lint
description = Run FLAKE8 linting
deps =
  flake8
  flake8-pyproject
change_dir = {toxinidir}
commands =
  flake8 {posargs:{[common]format_dirs}}

[testenv:pylint-lint]
labels = lint
description = Run pylint tests that are disabled by the default Ansible sanity tests
deps =
  pylint
change_dir = {toxinidir}
commands =
  pylint \
    --disable R,C,W,E \
    --enable pointless-statement \
    --enable consider-using-dict-items \
    --enable assignment-from-no-return \
    --enable no-else-continue \
    --enable no-else-break \
    --enable simplifiable-if-statement \
    --enable pointless-string-statement \
    --enable redefined-outer-name \
    --enable redefined-builtin \
    --enable unused-import \
    {posargs:{[common]lint_dirs}}

[testenv:ruff]
description = lint source code
labels = format-future
deps =
    ruff
change_dir = {toxinidir}
commands =
    ruff check --fix {posargs:{[common]lint_dirs}}
    ruff format {posargs:{[common]lint_dirs}}

[testenv:ruff-lint]
description = lint source code
labels = lint-future
deps =
    ruff
change_dir = {toxinidir}
commands =
    ruff check --diff --unsafe-fixes {posargs:{[common]lint_dirs}}
    ruff check {posargs:{[common]lint_dirs}}

[testenv:ansible-lint-future]
labels = future-lint
description = Run ansible-lint
deps =
  ansible-lint
  jmespath
  git+https://github.com/ansible/ansible.git@devel
  shellcheck-py
commands =
  ansible-lint \
        {posargs:{[common]lint_dirs}}

[testenv:ansible-sanity]
labels = future-lint
description = Run latest (devel) Ansible sanity tests
deps =
  git+https://github.com/ansible/ansible.git@devel
  shellcheck-py
commands =
  ansible-test sanity

[testenv:mypy-lint]
allowlist_externals = rsync,ln
labels = future-lint
description = Run mypy type tests
set_env =
  ANSIBLE_HOME={[common]ansible_home}
  ANSIBLE_COLLECTIONS_PATH={[common]ansible_collections_path}
  MYPYPATH={[common]ansible_home}
deps =
  mypy
  git+https://github.com/ansible/ansible.git@devel
  botocore
  boto3
  placebo
  typing_extensions
commands_pre =
  rsync --delete --exclude=.tox -qraugpo {toxinidir}/ {[common]full_collection_path}/
  ansible-galaxy collection install git+https://github.com/ansible-collections/amazon.aws.git
  ln -s {env_site_packages_dir}/ansible {[common]ansible_collections_path}/ansible
  ln -s {[common]ansible_home}/collections/ansible_collections {[common]ansible_home}/ansible_collections
commands =
  mypy \
    --check-untyped-defs \
    --namespace-packages --explicit-package-bases \
    --follow-imports silent \
    -p ansible_collections.amazon.ai.plugins.module_utils

[testenv:add_docs]
deps = git+https://github.com/ansible-network/collection_prep
commands = collection_prep_add_docs -p .
