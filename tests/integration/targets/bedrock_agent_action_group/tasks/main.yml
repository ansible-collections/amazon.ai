---
- name: Amazon Bedrock integration tests
  module_defaults:
    group/amazon.ai.aws:
      access_key: "{{ aws_access_key }}"
      secret_key: "{{ aws_secret_key }}"
      session_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
    group/aws:
      access_key: "{{ aws_access_key }}"
      secret_key: "{{ aws_secret_key }}"
      session_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
  block:
    - name: Get AWS caller info
      amazon.aws.aws_caller_info:
      register: caller_info

    - name: Save account ID
      ansible.builtin.set_fact:
        aws_account_id: "{{ caller_info.account }}"
        
    - name: Create IAM role for Bedrock Agent
      amazon.aws.iam_role:
        name: "{{ agent_role_name }}"
        assume_role_policy_document: "{{ lookup('file', 'assume_role_bedrock_agent.json') }}"
        state: present
        managed_policies:
          - "arn:aws:iam::aws:policy/AmazonBedrockFullAccess"
      register: agent_role

    - name: Save role ARN
      ansible.builtin.set_fact:
        agent_role_arn: "{{ agent_role.iam_role.arn }}"
    
    - name: Create IAM role for Lambda
      amazon.aws.iam_role:
        name: "{{ lambda_role_name }}"
        assume_role_policy_document: "{{ lookup('file', 'assume_role_lambda.json') }}"
        state: present
        managed_policies:
          - "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
      register: lambda_role

    - name: Wait for IAM role to propagate
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for IAM role to be fully propagated."
    
    - name: Ensure lambda_package directory exists
      ansible.builtin.file:
        path: /tmp/lambda_package
        state: directory
        mode: '0755'
    
    - name: Create dummy Lambda function deployment package using archive
      ansible.builtin.copy:
        dest: /tmp/lambda_package/lambda_function.py
        content: "{{ lookup('file', 'files/script.py') }}"

    - name: Install dependencies into package dir
      ansible.builtin.shell: |
        pip install requests -t /tmp/lambda_package
      args:
        creates: "/tmp/lambda_package/requests"

    - name: Create deployment zip archive
      ansible.builtin.archive:
        path: /tmp/lambda_package
        dest: /tmp/lambda.zip
        format: zip

    - name: Create Lambda function
      amazon.aws.lambda:
        name: "{{ lambda_name }}"
        runtime: python3.11
        role: "{{ lambda_role.iam_role.arn }}"
        handler: lambda_function.lambda_handler
        zip_file: "/tmp/lambda.zip"
      register: lambda_function
    
    - name: Attach Lambda resource-based policy for Bedrock action group
      amazon.aws.lambda_policy:
        state: present
        function_name: "{{ lambda_name }}"
        statement_id: "AllowBedrockInvocation"
        action: "lambda:InvokeFunction"
        principal: "bedrock.amazonaws.com"
        source_account: "{{ aws_account_id }}"
        source_arn: "arn:aws:bedrock:{{ aws_region }}:{{ aws_account_id }}:agent/*"

    - name: Wait for Lambda policy to propagate
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for Lambda resource-based policy to propagate."
    
    - name: Save lambda_arn variables
      ansible.builtin.set_fact:
        lambda_arn: "{{ lambda_function.configuration.function_arn }}"
    
    - name: Allow Bedrock Agent to invoke Lambda
      amazon.aws.iam_policy:
        iam_type: role
        iam_name: "{{ agent_role_name }}"
        policy_name: "BedrockInvokeLambdaPolicy"
        state: present
        policy_json: >
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Action": "lambda:InvokeFunction",
                "Resource": "{{ lambda_arn }}"
              }
            ]
          }

    - name: Wait for policy to propagate
      ansible.builtin.pause:
        seconds: 15
        prompt: "Waiting for policy to propagate."

    - name: Create Bedrock Agent
      amazon.ai.bedrock_agent:
        state: present
        agent_name: "{{ agent_name }}"
        foundation_model: "{{ foundation_model }}"
        instruction: "{{ instruction }}"
        agent_resource_role_arn: "{{ agent_role_arn }}"
      register: agent_create_first_run

    - name: Assert first run created the agent (check_mode)
      ansible.builtin.assert:
        that:
          - agent_create_first_run.changed
    
    - name: Save agent ID for subsequent tasks
      ansible.builtin.set_fact:
        agent_id: "{{ agent_create_first_run.agent.agent_id }}"
        
    - name: Create Agent Action Group (First Run - check_mode)
      amazon.ai.bedrock_agent_action_group:
        state: present
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        description: "Gets the current date and time."
        lambda_arn: "{{ lambda_arn }}"
        api_schema: "{{ lookup('file', 'files/api_schema.yaml') }}"
      check_mode: true
      register: action_group_result

    - name: Assert result has changed (check_mode)
      ansible.builtin.assert:
        that:
          - action_group_result.changed
          - "'Check mode: would have created action group' in action_group_result.msg"

    - name: Create Agent Action Group (First Run)
      amazon.ai.bedrock_agent_action_group:
        state: present
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        description: "Gets the current date and time."
        lambda_arn: "{{ lambda_arn }}"
        api_schema: "{{ lookup('file', 'files/api_schema.yaml') }}"
      register: action_group_result

    - name: Assert result has changed
      ansible.builtin.assert:
        that:
          - action_group_result.changed
          - "'created successfully' in action_group_result.msg"

    - name: Save agent action group ID for subsequent tasks
      ansible.builtin.set_fact:
        action_group_id: "{{ action_group_result.action_group.action_group_id }}"

    - name: Create Agent Action Group (Second Run - Idempotency Test -  check_mode)
      amazon.ai.bedrock_agent_action_group:
        state: present
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        description: "Gets the current date and time."
        lambda_arn: "{{ lambda_arn }}"
        api_schema: "{{ lookup('file', 'files/api_schema.yaml') }}"
      check_mode: true
      register: action_group_second_run

    - name: Assert second run was idempotent
      ansible.builtin.assert:
        that:
          - not action_group_second_run.changed
          - action_group_second_run.msg is search("No updates needed.")

    - name: Create Agent Action Group (Second Run - Idempotency Test)
      amazon.ai.bedrock_agent_action_group:
        state: present
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        description: "Gets the current date and time."
        lambda_arn: "{{ lambda_arn }}"
        api_schema: "{{ lookup('file', 'files/api_schema.yaml') }}"
      register: action_group_second_run

    - name: Assert second run was idempotent
      ansible.builtin.assert:
        that:
          - not action_group_second_run.changed
          - action_group_second_run.msg is search("No updates needed.")
    
    - name: Get action group
      amazon.ai.bedrock_agent_action_group_info:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
      register: agent_details

    - name: Assert that action group exists
      ansible.builtin.assert:
        that:
          - agent_details.action_groups is defined

    - name: List action groups
      amazon.ai.bedrock_agent_action_group_info:
        agent_name: "{{ agent_name }}"
      register: list_action_groups_output
    
    - name: Assert that action group exists
      ansible.builtin.assert:
        that:
          - list_action_groups_output.action_groups is defined
          - list_action_groups_output.action_groups | length > 0
    
    - name: Delete Agent action group
      amazon.ai.bedrock_agent_action_group:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        state: absent
      register: action_group_delete
      ignore_errors: true

    - name: Assert delete Agent action group has failed
      ansible.builtin.assert:
        that:
          - action_group_delete is failed

    - name: Disable Agent action group (First Run - check_mode)
      amazon.ai.bedrock_agent_action_group:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        action_group_state: "DISABLED"
        lambda_arn: "{{ lambda_arn }}"
        api_schema: "{{ lookup('file', 'files/api_schema.yaml') }}"
      check_mode: true
      register: action_group_disable

    - name: Assert that Agent action group has been disabled (check_mode)
      ansible.builtin.assert:
        that:
          - action_group_disable.changed
          - "'Check mode: would have updated action group' in action_group_disable.msg"

    - name: Disable Agent action group (First Run)
      amazon.ai.bedrock_agent_action_group:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        action_group_state: "DISABLED"
        lambda_arn: "{{ lambda_arn }}"
        api_schema: "{{ lookup('file', 'files/api_schema.yaml') }}"
      register: action_group_disable

    - name: Assert that Agent action group has been disabled
      ansible.builtin.assert:
        that:
          - action_group_disable.changed
          - action_group_disable.action_group.action_group_state == 'DISABLED'
          - "'updated successfully' in action_group_disable.msg"

    - name: Disable Agent action group (Second Run - Idempotency Test)
      amazon.ai.bedrock_agent_action_group:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        action_group_state: "DISABLED"
        lambda_arn: "{{ lambda_arn }}"
        api_schema: "{{ lookup('file', 'files/api_schema.yaml') }}"
      register: action_group_disable

    - name: Assert that Agent action group has been disabled
      ansible.builtin.assert:
        that:
          - not action_group_disable.changed
          - action_group_disable.msg is search("No updates needed.")

    - name: Wait until the action group state is DISABLED
      amazon.ai.bedrock_agent_action_group_info:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
      register: list_action_groups_output
      until: list_action_groups_output.action_groups[0].action_group_state == 'DISABLED'
      retries: 20
      delay: 10

    - name: Delete Agent action group (check_mode)
      amazon.ai.bedrock_agent_action_group:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        state: absent
      check_mode: true
      register: action_group_delete

    - name: Assert delete Agent action group has been deleted (check_mode)
      ansible.builtin.assert:
        that:
          - action_group_delete.changed
          - "'Check mode: would have deleted action group' in action_group_delete.msg"

    - name: Delete Agent action group (First Run)
      amazon.ai.bedrock_agent_action_group:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        state: absent
      register: action_group_delete

    - name: Assert delete Agent action group has been deleted (First Run)
      ansible.builtin.assert:
        that:
          - action_group_delete.changed
          - "'deleted successfully' in action_group_delete.msg"
    
    - name: Delete Agent action group (Second Run - Idempotency)
      amazon.ai.bedrock_agent_action_group:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        state: absent
      register: action_group_delete

    - name: Assert delete Agent action group has been deleted (Second Run - Idempotency)
      ansible.builtin.assert:
        that:
          - not action_group_delete.changed
          - "'Action group does not exist.' in action_group_delete.msg"
  always:
    - name: Get action group
      amazon.ai.bedrock_agent_action_group_info:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
      register: get_action_group
      ignore_errors: true

    - block:
      - name: Disable Agent action group
        amazon.ai.bedrock_agent_action_group:
          agent_name: "{{ agent_name }}"
          action_group_name: "{{ action_group_name }}"
          action_group_state: "DISABLED"
          lambda_arn: "{{ lambda_arn }}"
          api_schema: "{{ lookup('file', 'files/api_schema.yaml') }}"
        ignore_errors: true

      - name: Wait until the action group state is DISABLED
        amazon.ai.bedrock_agent_action_group_info:
          agent_name: "{{ agent_name }}"
          action_group_name: "{{ action_group_name }}"
        register: list_action_groups_output
        ignore_errors: true
        until: list_action_groups_output.action_group.action_group_state == 'DISABLED'
        retries: 20
        delay: 10
      when: get_action_group.action_groups != [] and get_action_group.action_groups[0].action_group_state != 'DISABLED'

    - name: Delete Agent action group
      amazon.ai.bedrock_agent_action_group:
        agent_name: "{{ agent_name }}"
        action_group_name: "{{ action_group_name }}"
        state: absent
      ignore_errors: true
  
    - name: Delete Bedrock Agent
      amazon.ai.bedrock_agent:
        state: absent
        agent_name: "{{ agent_name }}"
      ignore_errors: true
    
    - name: Remove Bedrock access from Lambda for agent action groups
      amazon.aws.lambda_policy:
        state: absent
        function_name: "{{ lambda_name }}"
        statement_id: "BedrockInvokeFunction"
        action: "lambda:InvokeFunction"
        principal: "bedrock.amazonaws.com"
        source_account: "{{ aws_account_id }}"
        source_arn: "arn:aws:bedrock:{{ aws_region }}:{{ aws_account_id }}:agent/{{ agent_id }}"
      ignore_errors: true

    - name: Delete Lambda function
      amazon.aws.lambda:
        name: "{{ lambda_name }}"
        state: absent
      ignore_errors: true

    - name: Delete IAM role for Lambda
      amazon.aws.iam_role:
        name: "{{ lambda_role_name }}"
        state: absent
        delete_instance_profile: true
      ignore_errors: true

    - name: Delete policy
      amazon.aws.iam_policy:
        state: absent
        iam_name: "{{ agent_role_name }}"
        iam_type: "role"
        policy_name: "BedrockInvokeLambdaPolicy"
      ignore_errors: true

    - name: Delete IAM role for Bedrock Agent
      amazon.aws.iam_role:
        name: "{{ agent_role_name }}"
        state: absent
        delete_instance_profile: true
      ignore_errors: true
    
    - name: Remove temporary files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/lambda.zip"
        - "/tmp/lambda_package"
      ignore_errors: true
