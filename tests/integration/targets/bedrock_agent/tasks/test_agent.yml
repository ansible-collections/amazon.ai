---
- name: Create Bedrock Agent (First Run)
  amazon.ai.bedrock_agent:
    state: present
    agent_name: "{{ agent_name }}"
    foundation_model: "{{ foundation_model }}"
    instruction: "{{ instruction }}"
    role_arn: "{{ agent_role_arn }}"
  register: agent_create_first_run

- name: Assert first run created the agent
  ansible.builtin.assert:
    that: agent_create_first_run.changed

- name: Save agent ID for subsequent tasks
  ansible.builtin.set_fact:
    agent_id: "{{ agent_create_first_run.agent_id }}"

- name: Create Bedrock Agent (Second Run - Idempotency Test)
  amazon.ai.bedrock_agent:
    state: present
    agent_name: "{{ agent_name }}"
    foundation_model: "{{ foundation_model }}"
    instruction: "{{ instruction }}"
    role_arn: "{{ agent_role_arn }}"
  register: agent_create_second_run

- name: Assert second run was idempotent
  ansible.builtin.assert:
    that: not agent_create_second_run.changed

- name: Create Agent Action Group
  amazon.ai.bedrock_agent_action_group:
    state: present
    agent_name: "{{ agent_name }}"
    action_group_name: "get-time"
    lambda_arn: "{{ lambda_arn }}"
    api_schema_path: "./api_schema.yaml"
  register: action_group_result

- name: Create Agent Alias
  amazon.ai.bedrock_agent_alias:
    state: present
    agent_name: "{{ agent_name }}"
    alias_name: "test-alias"
  register: alias_result

- name: Get info about a specific agent
  amazon.ai.bedrock_agent_info:
    agent_name: "{{ agent_name }}"
  register: agent_details

- name: Assert agent is in PREPARED state
  ansible.builtin.assert:
    that:
      - get_agent_output.agent is defined
      - get_agent_output.agent.agentStatus == 'PREPARED'

- name: Get action group
  amazon.ai.bedrock_agent_action_group_info:
    agent_name: "{{ agent_name }}"
  register: list_action_groups_output

- name: Get list of agent aliases
  amazon.ai.bedrock_agent_alias_info:
    agent_name: "{{ agent_name }}"
  register: alias_list
