---
- name: Delete Bedrock Agent
  amazon.aibedrock_agent:
    state: absent
    agent_name: "{{ agent_name }}"
    foundation_model: "anthropic.claude-v2"  # Required for idempotent deletion
    instruction: "You are a friendly chat bot." # Required for idempotent deletion
    role_arn: "{{ agent_role_arn }}"           # Required for idempotent deletion

- name: Delete Lambda function
  community.aws.lambda_function:
    name: "{{ lambda_name }}"
    state: absent

- name: Delete IAM role for Lambda
  community.aws.iam_role:
    name: "{{ lambda_role_name }}"
    state: absent

- name: Delete IAM role for Bedrock Agent
  community.aws.iam_role:
    name: "{{ agent_role_name }}"
    state: absent

- name: Remove temporary files
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "./lambda.zip"
    - "./test_vars.yml"
  delegate_to: localhost