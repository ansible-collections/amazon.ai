---
- name: Create IAM role for Bedrock Agent
  community.aws.iam_role:
    name: "{{ agent_role_name }}"
    assume_role_policy_document: "{{ lookup('file', 'assume_role_bedrock_agent.json') }}"
    state: present
  register: agent_role

- name: Create IAM role for Lambda
  community.aws.iam_role:
    name: "{{ lambda_role_name }}"
    assume_role_policy_document: "{{ lookup('file', 'assume_role_lambda.json') }}"
    state: present
  register: lambda_role

- name: Attach basic Lambda execution policy to Lambda role
  community.aws.iam_policy:
    iam_role: "{{ lambda_role_name }}"
    policy_arn: "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
    state: present

- name: Create a dummy Lambda function deployment package
  ansible.builtin.command: |
    python -c "import zipfile; zf = zipfile.ZipFile('lambda.zip', 'w'); zf.writestr('lambda_function.py', 'def lambda_handler(event, context): return {\"statusCode\": 200}'); zf.close()"
  args:
    creates: "lambda.zip"

- name: Create Lambda function
  community.aws.lambda_function:
    name: "{{ lambda_name }}"
    runtime: python3.11
    role: "{{ lambda_role.arn }}"
    handler: lambda_function.lambda_handler
    zip_file: "./lambda.zip"
    publish: true
  register: lambda_function

- name: Save test variables to a file
  ansible.builtin.copy:
    content: |
      agent_name: "{{ agent_name }}"
      agent_role_arn: "{{ agent_role.arn }}"
      lambda_name: "{{ lambda_name }}"
      lambda_arn: "{{ lambda_function.function.function_arn }}"
      region: "{{ region }}"
    dest: "test_vars.yml"
  delegate_to: localhost