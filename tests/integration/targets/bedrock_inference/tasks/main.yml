- name: Amazon Bedrock Inference integration tests
  module_defaults:
    group/amazon.ai.aws:
      access_key: "{{ aws_access_key }}"
      secret_key: "{{ aws_secret_key }}"
      session_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
  block:
    - name: List all foundation models without filters
      amazon.ai.bedrock_foundation_models_info:
      register: list_all_result

    - name: The task ran successfully and returned a list
      ansible.builtin.assert:
        that:
          - list_all_result is success
          - not list_all_result is changed
          - list_all_result.model_summaries is defined
          - list_all_result.model_summaries | length > 0
        msg: "The bedrock_foundation_models_info task failed or did not return a valid list."

    - name: List models filtered by provider 'Amazon'
      amazon.ai.bedrock_foundation_models_info:
        by_provider: 'Amazon'
      register: list_amazon_result

    - name: Assert that all models in the list are from the 'Amazon' provider
      ansible.builtin.assert:
        that:
          - list_amazon_result.model_summaries | selectattr('provider_name', 'equalto', 'Amazon') | list | length == list_amazon_result.model_summaries | length
        msg: "The list contains models from other providers, which is incorrect."

    - name: Extract an on-demand 'Nova Micro' model ID
      ansible.builtin.set_fact:
        amazon_model_summary: >-
          {{ list_amazon_result.model_summaries
            | selectattr('model_name', 'contains', 'Nova Micro')
            | selectattr('inference_types_supported', 'contains', 'ON_DEMAND')
            | first }}

    - name: Assert that a valid 'Nova Micro' on-demand model was found
      ansible.builtin.assert:
        that:
          - amazon_model_summary is defined
          - amazon_model_summary.model_id is defined
          - "'ON_DEMAND' in amazon_model_summary.inference_types_supported"
        msg: "Could not find an on-demand Nova Micro model. Your AWS account may not have access."

    - name: Extract a model_id from the filtered list
      ansible.builtin.set_fact:
        model_id: "{{ amazon_model_summary.model_id }}"

    - name: Invoke the Bedrock model with a simple prompt
      amazon.ai.bedrock_model_inference:
        model_id: "{{ model_id }}"
        prompt: "{{ test_prompt }}"
      register: inference_result

    - name: Assert the task ran successfully
      ansible.builtin.assert:
        that:
          - inference_result is success
          - inference_result is changed
        msg: "The bedrock_inference task did not succeed or did not report a change."

    - name: Assert the returned raw_response is a non-empty 
      ansible.builtin.assert:
        that:
          - inference_result.raw_response is defined
        msg: "The inference_result.raw_response was not returned or was empty."

    - name: Assert the returned values match the input
      ansible.builtin.assert:
        that:
          - inference_result.model_id == model_id
          - inference_result.prompt == test_prompt
        msg: "The returned model_id or prompt did not match the input."
