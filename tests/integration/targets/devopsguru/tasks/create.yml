---
- name: Get ARN of calling user
  amazon.aws.aws_caller_info:
  register: aws_caller_info

- name: Create S3 bucket
  amazon.aws.s3_bucket:
    name: "{{ s3_bucket_name }}"
  register: s3_output

- name: Get latest Amazon Linux 2 AMI
  amazon.aws.ec2_ami_info:
    owners: ["amazon"]
    filters:
      name: "amzn2-ami-hvm-*-x86_64-gp2"
      state: "available"
  register: ami_info

- name: Extract the latest AMI ID
  set_fact:
    ami_id: "{{ ami_info.images | sort(attribute='creation_date') | last  }}"

- name: Deploy RDS CloudFormation stack
  amazon.aws.cloudformation:
    stack_name: "{{ stack_name }}"
    state: present
    template_body: "{{ lookup('template', 'cloudformation.yaml.j2') }}"
    template_parameters:
      AmiId: "{{ ami_id.image_id }}"
      InstanceType: "t2.medium"
    capabilities:
      - CAPABILITY_NAMED_IAM
  register: stack_info

- name: Assert DevOpsGuru Resource Collection result is defined
  ansible.builtin.assert:
    that:
      - '"Stack CREATE complete" in stack_info.output'

- name: Enable DevOpsGuru on Stack (check_mode)
  amazon.ai.devopsguru_resource_collection:
    state: present
    cloudformation_stack_names:
        - "{{ stack_name }}"
  check_mode: true
  register: enable_devopsguru

- name: Assert that DevOpsGuru has been enabled on Stack (check_mode)
  ansible.builtin.assert:
    that:
      - enable_devopsguru.changed
      - '"Check mode: would have updated resource collection." in enable_devopsguru.msg'

- name: Enable DevOpsGuru on Stack
  amazon.ai.devopsguru_resource_collection:
    state: present
    cloudformation_stack_names:
        - "{{ stack_name }}"
  register: enable_devopsguru

- name: Assert that DevOpsGuru has been enabled on Stack
  ansible.builtin.assert:
    that:
      - enable_devopsguru.changed
      - '"Resource collection updated successfully." in enable_devopsguru.msg'

- name: Enable DevOpsGuru on Stack (idempotency)
  amazon.ai.devopsguru_resource_collection:
    state: present
    cloudformation_stack_names:
        - "{{ stack_name }}"
  register: enable_devopsguru

- name: Assert that DevOpsGuru has been enabled on Stack
  ansible.builtin.assert:
    that:
      - not enable_devopsguru.changed

- name: Gather information about DevOpsGuru Resource Collections - "AWS_CLOUD_FORMATION"
  amazon.ai.devopsguru_resource_collection_info:
    resource_collection_type: "AWS_CLOUD_FORMATION"
  register: resource_collection_info

- name: Assert DevOpsGuru Resource Collection result is defined
  ansible.builtin.assert:
    that:
      - resource_collection_info.resource_collection is defined

- name: Get ARN of the IAM Role
  amazon.aws.iam_role_info:
    name: "SSMManagedInstanceRole"
  register: role_info

- name: Create a KMS key
  amazon.aws.kms_key:
    alias: '{{ kms_key_name }}'
    grants:
    - name: SSM-Agent-Access
      grantee_principal: '{{ role_info.iam_roles[0].arn }}'
      retiring_principal: '{{ aws_caller_info.arn }}'
      operations:
        - Decrypt
        - Encrypt
        - GenerateDataKey
        - GenerateDataKeyWithoutPlaintext
        - DescribeKey
        - Verify
        - Sign
        - RetireGrant
    - name: Ansible-Test-Access
      grantee_principal: '{{ aws_caller_info.arn }}'
      retiring_principal: '{{ aws_caller_info.arn }}'
      operations:
        - Decrypt
        - Encrypt
        - GenerateDataKey
        - GenerateDataKeyWithoutPlaintext
        - DescribeKey
        - Verify
        - Sign
        - RetireGrant
  register: cmk_setup

- name: Ensure S3 bucket is configured for encryption
  amazon.aws.s3_bucket:
    name: "{{ s3_bucket_name }}"
    encryption: "aws:kms"
    encryption_key_id: "{{ cmk_setup.key_arn }}"
    bucket_key_enabled: True

- name: Gather information about DevOpsGuru Resource Collections - "AWS_SERVICE"
  amazon.ai.devopsguru_resource_collection_info:
    resource_collection_type: "AWS_SERVICE"
  check_mode: true
  register: resource_collection_info

- name: Assert DevOpsGuru Resource Collection result is defined
  ansible.builtin.assert:
    that:
      - resource_collection_info.resource_collection is defined

- name: Gather information about DevOpsGuru Resource Collections - "AWS_TAGS"
  amazon.ai.devopsguru_resource_collection_info:
    resource_collection_type: "AWS_TAGS"
  register: resource_collection_info

- name: Assert DevOpsGuru Resource Collection result is defined
  ansible.builtin.assert:
    that:
      - resource_collection_info.resource_collection is defined

- name: Gather information about DevOpsGuru Resource Insights
  amazon.ai.devopsguru_insight_info:
    status_filter:
      any:
        type: 'REACTIVE'
        start_time_range:
          from_time: "2025-02-10"
          to_time: "2025-02-12"
  register: insight_info

- name: Assert DevOpsGuru Insight result is defined
  ansible.builtin.assert:
    that:
      - insight_info.reactive_insights == []

- name: Gather information about DevOpsGuru Resource Insights with recommendations and anomalies
  amazon.ai.devopsguru_insight_info:
    status_filter:
      any:
        type: 'REACTIVE'
        start_time_range:
          from_time: "2025-02-10"
          to_time: "2025-02-12"
    include_recommendations:
      locale: 'EN_US'
    include_anomalies:
      start_time_range:
        from_time: "2025-02-10"
        to_time: "2025-02-12"

- name: Assert DevOpsGuru Insight result is defined
  ansible.builtin.assert:
    that:
      - insight_info.reactive_insights == []

- name: Remove Stack from DevOpsGuru (check_mode)
  amazon.ai.devopsguru_resource_collection:
    state: absent
    cloudformation_stack_names: []
  check_mode: true
  register: remove_stacks

- name: Assert that Stacks have been removed from DevOpsGuru (check_mode)
  ansible.builtin.assert:
    that:
      - remove_stacks.changed
      - '"Check mode: would have updated resource collection." in remove_stacks.msg'

- name: Remove Stack from DevOpsGuru
  amazon.ai.devopsguru_resource_collection:
    state: absent
    cloudformation_stack_names: []
  register: remove_stacks

- name: Assert that Stacks have been removed from DevOpsGuru
  ansible.builtin.assert:
    that:
      - remove_stacks.changed

- name: Remove Stack from DevOpsGuru (idempotency)
  amazon.ai.devopsguru_resource_collection:
    state: absent
    cloudformation_stack_names: []
  register: remove_stacks

- name: Assert that Stacks have been removed from DevOpsGuru (idempotency)
  ansible.builtin.assert:
    that:
      - not remove_stacks.changed
