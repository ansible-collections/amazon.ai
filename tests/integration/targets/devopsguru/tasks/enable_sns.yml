---
- name: Create SNS Topic
  community.aws.sns_topic:
    name: "{{ sns_topic_name }}"
    display_name: My DevOpsGuruNotifications name
    state: present
  register: sns_topic

- name: Create SQS queue to receive DevOps Guru notifications
  community.aws.sqs_queue:
    name: "{{ sqs_queue_name }}"
  register: sqs_result

- name: Subscribe SQS queue to SNS topic
  community.aws.sns_topic:
    name: "{{ sns_topic_name }}"
    state: present
    subscriptions:
      - endpoint: "{{ sqs_result.queue_arn }}"
        protocol: sqs

- name: Create DevOps Guru Notification Channel (check_mode)
  amazon.ai.devopsguru_resource_collection:
    cloudformation_stack_names:
      - "{{ stack_name }}"
    state: present
    notification_channel_config:
      sns:
        topic_arn: "{{ sns_topic.sns_arn }}"
      filters:
        severities:
          - HIGH
          - MEDIUM
  check_mode: true
  register: notification_channel

- name: Assert that Notification Channel has been created (check_mode)
  ansible.builtin.assert:
    that:
      - notification_channel.changed
      - "'Check mode: would have added notification channel.' in notification_channel.msg"

- name: Create DevOps Guru Notification Channel
  amazon.ai.devopsguru_resource_collection:
    cloudformation_stack_names:
      - "{{ stack_name }}"
    state: present
    notification_channel_config:
      sns:
        topic_arn: "{{ sns_topic.sns_arn }}"
      filters:
        severities:
          - HIGH
          - MEDIUM
  register: notification_channel

- name: Assert that Notification Channel has been created
  ansible.builtin.assert:
    that:
      - notification_channel.changed
      - notification_channel.notification_channel is defined 
      - "'Notification channel added successfully.' in notification_channel.msg"

- name: Create DevOps Guru Notification Channel (idempotency)
  amazon.ai.devopsguru_resource_collection:
    cloudformation_stack_names:
      - "{{ stack_name }}"
    state: present
    notification_channel_config:
      sns:
        topic_arn: "{{ sns_topic.sns_arn }}"
      filters:
        severities:
          - HIGH
          - MEDIUM
  register: notification_channel

- name: Assert that Notification Channel has been created (idempotency)
  ansible.builtin.assert:
    that:
      - not notification_channel.changed
